# Version 3 (v3) - Hybrid Metrics + Insights

**Date:** 2026-01-18
**Status:** Current (Recommended)

## Philosophy

**Two-part report architecture** separating deterministic metrics from LLM-powered insights. Enables both programmatic analysis and executive-ready narratives.

## Evolution

| Version | Fields | Focus | Status |
|---------|--------|-------|--------|
| v0 | ~15 | Basic funnel/outcome | Archived |
| v1 | ~50 | Comprehensive (overengineered) | Archived |
| v2 | 14 | Simplified actionable | Previous |
| **v3** | **18** | Hybrid metrics + insights | **Current** |

## Schema (18 per-call fields)

### Retained from v2 (14 fields)

```json
{
  "call_id": "string",
  "outcome": "resolved | escalated | abandoned | unclear",
  "resolution_type": "string",
  "agent_effectiveness": "1-5",
  "conversation_quality": "1-5",
  "customer_effort": "1-5",
  "failure_point": "none | nlu_miss | wrong_action | policy_gap | customer_confusion | tech_issue | other",
  "failure_description": "string | null",
  "was_recoverable": "boolean | null",
  "critical_failure": "boolean",
  "escalation_requested": "boolean",
  "repeat_caller_signals": "boolean",
  "training_opportunity": "string | null",
  "additional_intents": "string | null",
  "summary": "string"
}
```

### New v3 Fields (4 fields)

```json
{
  "policy_gap_detail": {
    "category": "capability_limit | data_access | auth_restriction | business_rule | integration_missing",
    "specific_gap": "what exactly couldn't be done",
    "customer_ask": "what the customer wanted",
    "blocker": "why it couldn't be fulfilled"
  },
  "customer_verbatim": "key quote capturing frustration/need",
  "agent_miss_detail": "what agent should have said/done differently",
  "resolution_steps": ["action1", "action2", "..."]
}
```

### Policy Gap Categories

| Category | Description |
|----------|-------------|
| `capability_limit` | Feature not built yet (e.g., can't process refunds) |
| `data_access` | Agent can't access needed information |
| `auth_restriction` | Customer couldn't be verified to proceed |
| `business_rule` | Policy prevents action (e.g., can't waive fees) |
| `integration_missing` | System integration not available |

## Validation Rules

1. **failure_point consistency**: If `outcome` ∈ {abandoned, escalated, unclear} → `failure_point` MUST NOT be "none"
2. **policy_gap_detail required**: If `failure_point` = "policy_gap" → `policy_gap_detail` MUST be populated
3. **agent_miss_detail conditional**: If `was_recoverable` = true → `agent_miss_detail` SHOULD be populated

## Two-Part Report

### Section A: Deterministic Metrics (Python-calculated)

All metrics computed via Python - no LLM involved. Reproducible and auditable.

- Outcome distribution with rates
- Key rates (success, containment, escalation, failure)
- Quality score statistics (mean, median, std)
- Failure analysis by failure_point
- Policy gap breakdown by category
- Top specific gaps and customer asks
- Actionable flags (escalation, repeat callers, multi-intent)
- Training priorities

### Section B: LLM-Generated Insights

Generated by passing Section A metrics + aggregated natural language fields to LLM.

- Executive summary (2-3 sentences)
- Root cause analysis (primary driver + contributing factors)
- Actionable recommendations (P0/P1/P2 with expected impact)
- Trend narratives (failure patterns, customer experience, agent performance)
- Verbatim highlights (most frustrated, most common ask, biggest miss)

## Output Files

```
reports/
├── metrics_v3_{timestamp}.json      # Complete structured report (Section A + B)
└── executive_summary_v3_{timestamp}.md  # Human-readable Markdown
```

## Usage

```bash
# Full pipeline
python3 tools/run_analysis.py

# Individual steps
python3 tools/sample_transcripts.py -n 50
python3 tools/batch_analyze.py
python3 tools/compute_metrics.py
python3 tools/generate_insights.py
python3 tools/render_report.py

# Quick test (5 transcripts)
python3 tools/run_analysis.py --quick
```

## Comparison

| Aspect | v2 | v3 |
|--------|----|----|
| Per-call fields | 14 | 18 |
| Report structure | Single JSON | Two-part (metrics + insights) |
| Policy gap detail | None | Structured breakdown |
| Customer voice | None | Verbatim quotes |
| Agent coaching | training_opportunity only | + agent_miss_detail |
| Call flow | summary only | + resolution_steps |
| Output formats | JSON only | JSON + Markdown |
